name: Helm Chart Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'charts/**'
      - '.github/workflows/test.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'charts/**'
      - '.github/workflows/test.yml'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Helm
      uses: azure/setup-helm@v4
      with:
        version: '3.17.0'
        
    - name: Install helm-unittest plugin
      run: |
        helm plugin install https://github.com/helm-unittest/helm-unittest
        
    - name: Run Helm Chart Tests
      run: |
        echo "ğŸ§ª Starting Helm Chart Testing with helm-unittest..."
        echo "â„¹ï¸  Helm version: $(helm version --short)"
        
        # Check if helm-unittest plugin is installed
        if helm plugin list | grep -q unittest; then
          echo "âœ… helm-unittest plugin is already installed"
        else
          echo "âŒ helm-unittest plugin not found"
          exit 1
        fi
        
        # Run helm lint
        echo "â„¹ï¸  Running helm lint..."
        helm lint charts/helm-base
        if [ $? -eq 0 ]; then
          echo "âœ… Chart linting passed"
        else
          echo "âŒ Chart linting failed"
          exit 1
        fi
        
        # Run helm-unittest tests
        echo "â„¹ï¸  Running helm-unittest tests..."
        helm unittest charts/helm-base
        if [ $? -eq 0 ]; then
          echo "âœ… Unit tests passed"
        else
          echo "âŒ Unit tests failed"
          exit 1
        fi
        
        # Test template rendering with default values
        echo "â„¹ï¸  Testing template rendering with default values..."
        helm template test charts/helm-base > /dev/null
        if [ $? -eq 0 ]; then
          echo "âœ… Default values render successfully"
        else
          echo "âŒ Default values render failed"
          exit 1
        fi
        
        # Test different workload types
        echo "â„¹ï¸  Testing different workload types..."
        
        # Test Deployment
        helm template test charts/helm-base --set kind=Deployment > /dev/null
        if [ $? -eq 0 ]; then
          echo "âœ… Deployment workload renders successfully"
        else
          echo "âŒ Deployment workload render failed"
          exit 1
        fi
        
        # Test StatefulSet
        helm template test charts/helm-base --set kind=StatefulSet > /dev/null
        if [ $? -eq 0 ]; then
          echo "âœ… StatefulSet workload renders successfully"
        else
          echo "âŒ StatefulSet workload render failed"
          exit 1
        fi
        
        # Test Job
        helm template test charts/helm-base --set kind=Job > /dev/null
        if [ $? -eq 0 ]; then
          echo "âœ… Job workload renders successfully"
        else
          echo "âŒ Job workload render failed"
          exit 1
        fi
        
        # Test CronJob
        helm template test charts/helm-base --set kind=CronJob --set schedule="0 0 * * *" > /dev/null
        if [ $? -eq 0 ]; then
          echo "âœ… CronJob workload renders successfully"
        else
          echo "âŒ CronJob workload render failed"
          exit 1
        fi
        
        # Test DaemonSet
        helm template test charts/helm-base --set kind=DaemonSet > /dev/null
        if [ $? -eq 0 ]; then
          echo "âœ… DaemonSet workload renders successfully"
        else
          echo "âŒ DaemonSet workload render failed"
          exit 1
        fi
        
        # Test with example values if they exist
        if [ -f "charts/helm-base/values.yaml" ]; then
          echo "â„¹ï¸  Testing with example values..."
          helm template test charts/helm-base -f charts/helm-base/values.yaml > /dev/null
          if [ $? -eq 0 ]; then
            echo "âœ… Example values render successfully"
          else
            echo "âŒ Example values render failed"
            exit 1
          fi
        fi
        
        # Test chart packaging
        echo "â„¹ï¸  Testing chart packaging..."
        helm package charts/helm-base --destination /tmp
        if [ $? -eq 0 ]; then
          echo "âœ… Chart packaging successful"
          echo "â„¹ï¸  Package created: $(ls /tmp/helm-base-*.tgz)"
        else
          echo "âŒ Chart packaging failed"
          exit 1
        fi
        
        echo ""
        echo "âœ… All tests passed! ğŸ‰"
        echo "â„¹ï¸  Chart is ready for deployment"
        echo ""
        echo "ğŸ“Š Test Summary:"
        echo "  âœ… Chart linting"
        echo "  âœ… Unit tests (helm-unittest)"
        echo "  âœ… Template rendering (default values)"
        echo "  âœ… Workload types (Deployment, StatefulSet, Job, CronJob, DaemonSet)"
        echo "  âœ… Example values"
        echo "  âœ… Chart packaging"
        echo ""
        echo "ğŸš€ Chart is production ready!"
        
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: helm-test-results
        path: |
          /tmp/helm-base-*.tgz
        retention-days: 7
