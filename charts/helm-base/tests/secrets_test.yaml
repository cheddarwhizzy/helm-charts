# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: secrets test
templates:
  - secrets.yaml
tests:
  - it: should not render secrets with default values
    asserts:
      - hasDocuments:
          count: 0

  - it: should render secret with basic config
    set:
      secrets:
        - name: app-secret
          type: Opaque
          data:
            username: username
            password: password
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-app-secret
      - equal:
          path: type
          value: Opaque
      - equal:
          path: data.username
          value: dXNlcm5hbWU=
      - equal:
          path: data.password
          value: cGFzc3dvcmQ=

  - it: should render secret with global secrets
    set:
      global:
        secrets:
          - name: global-secret
            type: Opaque
            data:
              key: global-data
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-global-secret

  - it: should render multiple secrets
    set:
      secrets:
        - name: first-secret
          type: Opaque
          data:
            key1: first
        - name: second-secret
          type: Opaque
          data:
            key2: second
    asserts:
      - hasDocuments:
          count: 2

  # Map-based secrets tests
  - it: should render map-based secret
    set:
      secrets:
        app-secret:
          type: Opaque
          data:
            username: username
            password: password
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-app-secret

  - it: should use map key as name when name not provided
    set:
      secrets:
        my-secret:
          type: Opaque
          data:
            key: value
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-my-secret

  - it: should allow explicit name to override map key
    set:
      secrets:
        secret-key:
          name: custom-name
          type: Opaque
          data:
            key: value
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-custom-name

  - it: should render multiple map-based secrets
    set:
      secrets:
        first:
          type: Opaque
          data:
            key1: first
        second:
          type: Opaque
          data:
            key2: second
    asserts:
      - hasDocuments:
          count: 2
