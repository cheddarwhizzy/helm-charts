# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: secretstore test
templates:
  - secretstore.yaml
tests:
  - it: should not render secretstore with default values
    asserts:
      - hasDocuments:
          count: 0

  - it: should render secretstore with basic config
    set:
      secretStore:
        create: true
        name: aws-secrets-manager
        service: SecretsManager
        region: us-west-2
      externalSecrets:
        auth:
          data:
            DATABASE_URL: /ci/my-service/database_url
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: SecretStore
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-aws-secrets-manager
      - equal:
          path: spec.provider.aws.service
          value: SecretsManager
      - equal:
          path: spec.provider.aws.region
          value: us-west-2
      - equal:
          path: spec.provider.aws.auth.jwt.serviceAccountRef.name
          value: RELEASE-NAME-helm-base

  - it: should render secretstore with ParameterStore
    set:
      secretStore:
        create: true
        name: aws-parameter-store
        service: ParameterStore
        region: us-east-1
      externalSecrets:
        config:
          data:
            APP_CONFIG: /ci/my-service/app_config
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: SecretStore
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-aws-parameter-store
      - equal:
          path: spec.provider.aws.service
          value: ParameterStore
      - equal:
          path: spec.provider.aws.region
          value: us-east-1

  - it: should render secretstore with custom fullname
    set:
      secretStore:
        create: true
        fullname: custom-store-name
        name: aws-secrets
        service: SecretsManager
        region: eu-west-1
      externalSecrets:
        auth:
          data:
            API_KEY: /ci/my-service/api_key
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: SecretStore
      - equal:
          path: metadata.name
          value: custom-store-name
