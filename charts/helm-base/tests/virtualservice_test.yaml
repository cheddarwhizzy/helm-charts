# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: virtualservice test
templates:
  - virtualservice.yaml
tests:
  - it: should not render virtualservice with default values
    asserts:
      - hasDocuments:
          count: 0

  - it: should render virtualservice with basic config
    set:
      virtualservice:
        enabled: true
        host: app.example.com
        gateway: istio-gateway
        port: 80
        routes:
          - name: default
            host: app.example.com
            port: 3000
            path: /
            gateway: mesh
            service: web
      services:
        - name: web
          type: ClusterIP
          ports:
            - name: http
              port: 3000
              targetPort: 3000
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: VirtualService
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-default
      - equal:
          path: spec.hosts[0]
          value: app.example.com
      - equal:
          path: spec.gateways[0]
          value: mesh
      - equal:
          path: spec.http[0].match[0].uri.prefix
          value: /
      - equal:
          path: spec.http[0].route[0].destination.host
          value: RELEASE-NAME-helm-base-web
      - equal:
          path: spec.http[0].route[0].destination.port.number
          value: 3000

  - it: should render virtualservice with custom configuration
    set:
      virtualservice:
        enabled: true
        host: api.example.com
        gateway: custom-gateway
        port: 8080
        annotations:
          virtualservice: annotation
        routes:
          - name: api-route
            host: api.example.com
            port: 8080
            path: /api
            service: api
            tls: true
            corsPolicy:
              allowOrigins:
                - exact: "https://example.com"
              allowMethods:
                - GET
                - POST
            retries:
              attempts: 3
              perTryTimeout: 2s
            timeout: 30s
      services:
        - name: api
          type: ClusterIP
          ports:
            - name: http
              port: 8080
              targetPort: 8080
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: VirtualService
      - equal:
          path: metadata.annotations.virtualservice
          value: annotation
      - equal:
          path: spec.http[0].corsPolicy.allowOrigins[0].exact
          value: "https://example.com"
      - equal:
          path: spec.http[0].corsPolicy.allowMethods[0]
          value: GET
      - equal:
          path: spec.http[0].retries.attempts
          value: 3
      - equal:
          path: spec.http[0].timeout
          value: 30s

  # Map-based virtualservice routes tests
  - it: should render map-based virtualservice route
    set:
      virtualservice:
        enabled: true
        host: app.example.com
        port: 80
        routes:
          web:
            host: app.example.com
            port: 3000
            path: /
            service: web
      services:
        - name: web
          type: ClusterIP
          ports:
            - name: http
              port: 3000
              targetPort: 3000
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-web

  - it: should use map key as route name when name not provided
    set:
      virtualservice:
        enabled: true
        host: app.example.com
        port: 80
        routes:
          api-route:
            host: api.example.com
            port: 8080
            path: /api
            service: api
      services:
        - name: api
          type: ClusterIP
          ports:
            - name: http
              port: 8080
              targetPort: 8080
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-api-route

  - it: should allow explicit name to override map key
    set:
      virtualservice:
        enabled: true
        host: app.example.com
        port: 80
        routes:
          web:
            name: custom-route
            host: app.example.com
            port: 3000
            path: /
            service: web
      services:
        - name: web
          type: ClusterIP
          ports:
            - name: http
              port: 3000
              targetPort: 3000
    asserts:
      - hasDocuments:
          count: 1
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-custom-route
