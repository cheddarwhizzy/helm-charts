# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: externalsecret test
templates:
  - externalsecret.yaml
tests:
  - it: should not render externalsecret with default values
    asserts:
      - hasDocuments:
          count: 0

  - it: should render externalsecret with basic config
    set:
      secretStore:
        create: true
        name: aws-secrets-manager
        service: SecretsManager
        region: us-west-2
      externalSecrets:
        auth:
          data:
            DATABASE_URL: /ci/my-service/database_url
            API_KEY: /ci/my-service/api_key
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ExternalSecret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-auth
      - equal:
          path: spec.secretStoreRef.name
          value: aws-secrets-manager
      - equal:
          path: spec.secretStoreRef.kind
          value: ClusterSecretStore
      - equal:
          path: spec.data[0].secretKey
          value: DATABASE_URL
      - equal:
          path: spec.data[0].remoteRef.key
          value: /ci/my-service/database_url
      - equal:
          path: spec.data[1].secretKey
          value: API_KEY
      - equal:
          path: spec.data[1].remoteRef.key
          value: /ci/my-service/api_key

  - it: should render externalsecret with custom store name
    set:
      secretStore:
        create: true
        fullname: custom-secret-store
        name: aws-parameter-store
        service: ParameterStore
        region: us-east-1
      externalSecrets:
        config:
          data:
            APP_CONFIG: /ci/my-service/app_config
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ExternalSecret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-config
      - equal:
          path: spec.secretStoreRef.name
          value: custom-secret-store

  - it: should render template data for keys containing hyphens
    set:
      secretStore:
        create: true
        name: aws-parameter-store
      externalSecrets:
        api:
          data:
            api-key: /ci/my-service/api-key
    asserts:
      - equal:
          path: spec.target.template.data.api-key
          value: '{{ index . "api-key" | toString }}'
