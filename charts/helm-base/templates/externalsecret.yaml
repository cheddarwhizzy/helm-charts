{{- $root := . -}}
{{- $name := include "helm-base.fullname" . }}
{{- $commonLabels := include "helm-base.commonLabels" . }}
{{- $commonAnnotations := include "helm-base.commonAnnotations" . }}

{{- range $c := .Values.externalSecrets }}
{{- $secretStoreName := coalesce "aws-parameter-store" (printf "%s-%s" $name $root.Values.secretStore.name) $root.Values.secretStore.fullname }}
{{- $name := default (printf "%s-%s" $name $c.name) $c.fullname }}
---
apiVersion: external-secrets.io/v1alpha1
kind: ExternalSecret
metadata:
  name: {{ $name }}
  labels:
{{- $commonLabels | nindent 4 }}
  {{- if $commonAnnotations }}
  annotations:
{{- $commonAnnotations | nindent 4 }}
  {{- end }}
spec:
  refreshInterval: {{ default "1h" $c.refreshInterval }}
  secretStoreRef:
    name: {{ $secretStoreName }}
    kind: ClusterSecretStore
  target:
    name: {{ $name }} # name of kubernetes secret to create
    creationPolicy: Owner
    template:
      data:
{{- range $es := $c.data }}
        {{ $es.key }}: '{{`{{ .`}}{{ $es.key }}{{` | toString }}`}}' # put '{{ $es.key }}' temp key into the secret at '{{ $es.key }}'
{{- end }}
  data:
{{- range $es := $c.data }}
  - secretKey: {{ $es.key }} # load parameter into '{{ $es.key }}' temp key
    remoteRef:
      key: {{ tpl $es.value $root }}
{{- end }}

{{- end }} {{/* end range c */}}
