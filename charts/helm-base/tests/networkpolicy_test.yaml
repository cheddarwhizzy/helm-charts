# yaml-language-server: $schema=https://raw.githubusercontent.com/helm-unittest/helm-unittest/main/schema/helm-testsuite.json
suite: network policy test
templates:
  - networkpolicy.yaml
tests:
  - it: should render NetworkPolicy when enabled
    set:
      networkPolicy:
        enable: true
        policy: |
          podSelector:
            matchLabels:
              app.kubernetes.io/name: RELEASE-NAME
          ingress:
            - from:
                - namespaceSelector:
                    matchLabels:
                      name: frontend
              ports:
                - protocol: TCP
                  port: 80
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: NetworkPolicy
      - equal:
          path: metadata.name
          value: RELEASE-NAME-helm-base-policy

  - it: should not render NetworkPolicy when disabled
    set:
      networkPolicy:
        enable: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should render NetworkPolicy with egress rules
    set:
      networkPolicy:
        enable: true
        policy: |
          podSelector:
            matchLabels:
              app.kubernetes.io/name: RELEASE-NAME
          egress:
            - to:
                - namespaceSelector:
                    matchLabels:
                      name: database
              ports:
                - protocol: TCP
                  port: 5432
    asserts:
      - hasDocuments:
          count: 1
